---
import type { CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import SiteHeader from '../../components/SiteHeader.astro';
import { getCollection } from 'astro:content';
import { postsIndex } from '../../data/posts';
import { formatDate } from '../../utils/formatDate';

interface Props {
  entry: CollectionEntry<'posts'>;
}

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((entry) => ({
    params: { slug: entry.data.permalink },
    props: { entry },
  }));
}

const base = import.meta.env.BASE_URL;
const { entry } = Astro.props as Props;
const { Content, headings } = await entry.render();
const { title, heroImage, publishedAt, readingTime, sourceUrl, tags } = entry.data;

const currentIndex = postsIndex.findIndex((p) => p.permalink === entry.data.permalink);
const prevPost = currentIndex > 0 ? postsIndex[currentIndex - 1] : null;
const nextPost = currentIndex < postsIndex.length - 1 ? postsIndex[currentIndex + 1] : null;
---

<Layout title={`${title} â€” Mister Funable Field Notes`} ogImage={heroImage ?? undefined}>
  <SiteHeader />
  <article class="mx-auto max-w-4xl px-4 py-16 text-slate-200 lg:px-0">
    <a class="text-sm text-lime-200 hover:text-white" href={base}>&larr; Back home</a>
    <header class="mt-6 space-y-4">
      <p class="text-xs font-semibold uppercase tracking-[0.4em] text-lime-200/80">
        {formatDate(publishedAt)} &bull; {readingTime} min read
      </p>
      <h1 class="text-4xl font-semibold text-white">{title}</h1>
      <div class="flex flex-wrap gap-4 text-sm text-slate-400">
        <a class="underline-offset-4 hover:underline" href={sourceUrl} target="_blank" rel="noreferrer">
          View original on Medium
        </a>
      </div>
      {tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
            <span class="rounded-full border border-white/10 bg-white/5 px-3 py-1 text-xs text-slate-400">{tag}</span>
          ))}
        </div>
      )}
    </header>
    {heroImage && (
      <div class="mt-8 overflow-hidden rounded-3xl">
        <img src={heroImage} alt={title} class="h-full w-full object-cover" loading="eager" />
      </div>
    )}
    {headings.length > 2 && (
      <aside class="mt-10 rounded-2xl border border-white/10 bg-white/5 p-6 text-sm text-slate-300">
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-lime-200/80">On this page</p>
        <ul class="mt-4 space-y-2">
          {headings.map((heading) => {
            const indentClass = heading.depth > 2 ? 'ml-4' : '';
            return (
              <li class={indentClass}>
                <a class="text-slate-300 transition hover:text-white" href={`#${heading.slug}`}>
                  {heading.text}
                </a>
              </li>
            );
          })}
        </ul>
      </aside>
    )}
    <div class="richtext mt-10">
      <Content />
    </div>
  </article>

  <nav class="mx-auto flex max-w-4xl items-stretch border-t border-white/10 px-4 py-8 lg:px-0">
    <div class="flex-1">
      {prevPost && (
        <a href={`${base}posts/${prevPost.permalink}`} class="group block text-sm">
          <span class="text-xs uppercase tracking-widest text-slate-500 group-hover:text-lime-200">&larr; Previous</span>
          <p class="mt-1 font-semibold text-slate-300 group-hover:text-white">{prevPost.title}</p>
        </a>
      )}
    </div>
    <div class="flex-1 text-right">
      {nextPost && (
        <a href={`${base}posts/${nextPost.permalink}`} class="group block text-sm">
          <span class="text-xs uppercase tracking-widest text-slate-500 group-hover:text-lime-200">Next &rarr;</span>
          <p class="mt-1 font-semibold text-slate-300 group-hover:text-white">{nextPost.title}</p>
        </a>
      )}
    </div>
  </nav>
</Layout>
